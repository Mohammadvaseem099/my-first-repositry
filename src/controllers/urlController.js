const Url = require("../models/urlModel");
const validUrl = require("valid-url");
const shortid = require("shortid");

//==================================create-api===========================>>>

const baseUrl = "http:localhost:3000";
const shortUrl = async (req, res) => {
  const { longUrl } = req.body;

  if (!validUrl.isUri(baseUrl)) {
    return res.status(401).json("Invalid base URL");
  }

  const urlCode = shortid.generate();

  if (validUrl.isUri(longUrl)) {
    try {
      let url = await Url.findOne({ longUrl });

      if (url) {
        res.json(url);
      } else {
        const shortUrl = baseUrl + "/" + urlCode;

        url = new Url({ longUrl, shortUrl, urlCode });
        await url.save();
        res.json(url);
      }
    } catch (err) {
      console.log(err);
      res.status(500).json("Server Error");
    }
  } else {
    res.status(401).json("Invalid longUrl");
  }
};

//==================================get-api==============================>>>

const getUrl = async (req, res) => {
  try {
    let id = req.params.urlCode

    const url = await Url.findOne({ urlCode:id });

    if(!url){
       return res.send("Eroor")
    }
   return res.status(302).redirect(url.longUrl)
  } catch (err) {
    console.error(err);
    res.status(500).json("Server Error");
  }
};

module.exports = { shortUrl, getUrl };
